<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>APOS-HC 調査票 - 痛み部位入力</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .instructions {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 0 8px 8px 0;
    }

    .instructions h3 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .instructions ul {
      color: #555;
      line-height: 1.6;
    }

    .canvas-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin: 30px 0;
      background: #fafbfc;
      border-radius: 10px;
      padding: 20px;
      border: 2px dashed #e0e6ed;
      flex-wrap: wrap;
    }

    .canvas-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1 1 0;
      min-width: 0;
    }

    .canvas-label {
      margin-bottom: 10px;
      font-weight: bold;
      color: #2c3e50;
      font-size: 1.1em;
      text-align: center;
    }

    #bodyCanvas, #backBodyCanvas {
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      touch-action: none;
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .controls {
      text-align: center;
      margin-top: 30px;
    }

    .btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 10px;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }

    .btn-secondary:hover {
      box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
    }

    /* モーダルスタイル */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);

      /* 追加: モーダルの中身を中央に配置 */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal[style*="display: none"] {
      display: none !important;
    }

    .modal-content {
      background-color: white;
      /* margin: 15% auto; 削除 */
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease;
      /* 追加: 中央配置のための調整 */
      position: relative;
      left: 0;
      top: 0;
      transform: none;
    }

    /* 追加: ポップアップとして表示する場合のスタイル */
    .modal.popup {
      position: absolute;
      width: auto;
      height: auto;
      background: none;
      box-shadow: none;
      display: block;
      align-items: unset;
      justify-content: unset;
      z-index: 2000;
      pointer-events: none;
    }
    .modal.popup .modal-content {
      position: absolute;
      left: 0;
      top: 0;
      transform: none;
      margin: 0;
      pointer-events: auto;
      min-width: 180px;
      max-width: 220px;
      width: max-content;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      animation: modalSlideIn 0.2s;
      padding: 18px 10px 10px 10px;
    }
    .modal.popup .close {
      position: absolute;
      right: 8px;
      top: 4px;
      float: none;
      margin: 0;
      z-index: 2;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.4em;
    }

    .pain-levels {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
      justify-content: center;
      align-items: center;
    }

    .pain-level-btn {
      padding: 15px;
      border: 2px solid #e0e6ed;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .pain-level-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .pain-level-btn.level-0 {
      background: #f8f9fa;
      border-color: #6c757d;
      color: #6c757d;
    }

    .pain-level-btn.level-1 {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .pain-level-btn.level-2 {
      background: #ffeaa7;
      border-color: #fdcb6e;
      color: #d63031;
    }

    .pain-level-btn.level-3 {
      background: #fab1a0;
      border-color: #e17055;
      color: #d63031;
    }

    .pain-level-btn.level-4 {
      background: #ff7675;
      border-color: #d63031;
      color: white;
    }

    .pain-level-btn.selected {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -10px;
    }

    .close:hover {
      color: #000;
    }

    .pain-legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #ddd;
    }

    .legend-color.level-0 { background: #6c757d; }
    .legend-color.level-1 { background: #ffc107; }
    .legend-color.level-2 { background: #fdcb6e; }
    .legend-color.level-3 { background: #e17055; }
    .legend-color.level-4 { background: #d63031; }

    /* iPad対応 */
    @media screen and (max-width: 1024px) and (min-width: 769px) {
      .content {
        padding: 20px;
      }
      .canvas-container {
        flex-direction: row !important;
        gap: 20px;
      }
      #bodyCanvas, #backBodyCanvas {
        width: 100%;
        max-width: 350px;
      }
      .pain-levels {
        grid-template-columns: 1fr;
      }
    }

    /* スマートフォン対応 */
    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }
      .header {
        padding: 20px;
      }
      .header h1 {
        font-size: 1.8em;
      }
      .content {
        padding: 15px;
      }
      .modal-content {
        /* margin: 20% auto; 削除 */
        padding: 20px;
      }
      .canvas-container {
        flex-direction: column !important;
        gap: 20px;
      }
      .modal {
        align-items: center;
        justify-content: center;
      }
      .modal.popup .modal-content {
        min-width: 120px;
        max-width: 90vw;
        width: max-content;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="content">
      <div class="instructions">
        <h3>使用方法</h3>
        <ul>
          <li>身体図の痛みがある部位をマウスや指で手書きで囲んでください</li>
          <li>描画完了後、痛みの程度（0〜4）を選択してください</li>
          <li>複数箇所の痛みを記録できます</li>
          <li>「リセット」ボタンで全ての記録を消去できます</li>
        </ul>
      </div>

      <div class="pain-legend">
        <div class="legend-item">
          <div class="legend-color level-0"></div>
          <span>
            0. 無し
          </span>
        </div>
        <div class="legend-item">
          <div class="legend-color level-1"></div>
          <span>
            1. 時折、又は断続的な痛み
          </span>
        </div>
        <div class="legend-item">
          <div class="legend-color level-2"></div>
          <span>
            2. 時に調子の悪い日もある。痛みのため日常生活動作に支障をきたすこともある
          </span>
        </div>
        <div class="legend-item">
          <div class="legend-color level-3"></div>
          <span>
            3. しばしばひどい痛みがある。痛みにより日常生活や集中力に著しく支障をきたす
          </span>
        </div>
        <div class="legend-item">
          <div class="legend-color level-4"></div>
          <span>
            4. 持続的な耐えられない激しい痛みが持続的にある
          </span>
        </div>
      </div>

      <div class="canvas-container">
        <div class="canvas-block">
          <div class="canvas-label">前面</div>
          <canvas id="bodyCanvas" width="400" height="600"></canvas>
        </div>
        <div class="canvas-block">
          <div class="canvas-label">背面</div>
          <canvas id="backBodyCanvas" width="400" height="600"></canvas>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="resetCanvas()">リセット</button>
        <button class="btn" onclick="saveData()">データ保存</button>
      </div>
    </div>
  </div>

  <!-- 痛みレベル選択モーダル（ポップアップ位置調整対応） -->
  <div id="painModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>痛みの程度を選択してください</h3>
      <div class="pain-levels">
        <button class="pain-level-btn level-0" onclick="selectPainLevel(0)">
          <strong>0．無し</strong>
        </button>
        <button class="pain-level-btn level-1" onclick="selectPainLevel(1)">
          <strong>1．時折、又は断続的な痛み</strong>
        </button>
        <button class="pain-level-btn level-2" onclick="selectPainLevel(2)">
          <strong>2．時に調子の悪い日もある。痛みのため日常生活動作に支障をきたすこともある</strong>
        </button>
        <button class="pain-level-btn level-3" onclick="selectPainLevel(3)">
          <strong>3．しばしばひどい痛みがある。痛みにより日常生活や集中力に著しく支障をきたす</strong>
        </button>
        <button class="pain-level-btn level-4" onclick="selectPainLevel(4)">
          <strong>4．持続的な耐えられない激しい痛みが持続的にある</strong>
        </button>
      </div>
      </div>
    </div>
  </div>

  <script>
    let canvas, ctx;
    let backCanvas, backCtx;
    let painAreas = []; // 前面の痛みエリア
    let backPainAreas = []; // 背面の痛みエリア
    let currentPath = []; // 現在描画中のパス
    let isDrawing = false; // 描画中フラグ
    let currentCanvasType = null; // 'front' or 'back'
    let bodyImg = null;
    let backBodyImg = null;
    let modalScreenX = null;
    let modalScreenY = null;
    let modalCanvas = null;

    // 痛みレベルの色定義
    const painColors = {
      0: '#6c757d',  // グレー
      1: '#ffc107',  // 黄色
      2: '#fdcb6e',  // オレンジ
      3: '#e17055',  // 赤オレンジ
      4: '#d63031'   // 赤
    };

    // 初期化
    function init() {
      canvas = document.getElementById('bodyCanvas');
      ctx = canvas.getContext('2d');
      backCanvas = document.getElementById('backBodyCanvas');
      backCtx = backCanvas.getContext('2d');

      // 画像をロード
      bodyImg = new Image();
      bodyImg.src = 'boby.png';
      bodyImg.onload = function() {
        resizeCanvas();
      };

      backBodyImg = new Image();
      backBodyImg.src = 'backboby.png';
      backBodyImg.onload = function() {
        resizeCanvas();
      };

      // イベントリスナーを追加（手書き描画対応）
      // 前面キャンバス
      canvas.addEventListener('mousedown', function(event) {
        startDrawing(event, 'front');
      });
      canvas.addEventListener('mousemove', function(event) {
        draw(event, 'front');
      });
      canvas.addEventListener('mouseup', function(event) {
        stopDrawing(event, 'front');
      });
      canvas.addEventListener('touchstart', function(event) {
        handleTouch(event, 'front');
      }, { passive: false });
      canvas.addEventListener('touchmove', function(event) {
        handleTouch(event, 'front');
      }, { passive: false });
      canvas.addEventListener('touchend', function(event) {
        handleTouch(event, 'front');
      }, { passive: false });

      // 背面キャンバス
      backCanvas.addEventListener('mousedown', function(event) {
        startDrawing(event, 'back');
      });
      backCanvas.addEventListener('mousemove', function(event) {
        draw(event, 'back');
      });
      backCanvas.addEventListener('mouseup', function(event) {
        stopDrawing(event, 'back');
      });
      backCanvas.addEventListener('touchstart', function(event) {
        handleTouch(event, 'back');
      }, { passive: false });
      backCanvas.addEventListener('touchmove', function(event) {
        handleTouch(event, 'back');
      }, { passive: false });
      backCanvas.addEventListener('touchend', function(event) {
        handleTouch(event, 'back');
      }, { passive: false });

      // ウィンドウリサイズイベント
      window.addEventListener('resize', resizeCanvas);

      // 保存されたデータを復元
      loadData();

      // モーダルを必ず非表示にしておく
      closeModal();
    }

    // キャンバスサイズ調整
    function resizeCanvas() {
      if (!canvas || !backCanvas) return;
      const container = canvas.parentElement.parentElement; // .canvas-container
      const maxWidth = Math.min(400, container.clientWidth - 40);
      const aspectRatio = 400 / 600;
      const newWidth = maxWidth;
      const newHeight = newWidth / aspectRatio;

      [canvas, backCanvas].forEach(c => {
        c.style.width = newWidth + 'px';
        c.style.height = newHeight + 'px';
        c.width = newWidth;
        c.height = newHeight;
      });

      // 再描画
      drawBody();
      drawBackBody();
    }

    // 身体図の描画（前面）
    function drawBody() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 背景
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // 画像がロードされていれば描画
      if (bodyImg && bodyImg.complete) {
        ctx.drawImage(bodyImg, 0, 0, canvas.width, canvas.height);
      }

      // 痛みエリアを描画
      drawPainPoints(ctx, painAreas);
      
      // 現在描画中のパスを描画
      if (currentPath.length > 0 && currentCanvasType === 'front') {
        drawCurrentPath(ctx);
      }
    }

    // 身体図の描画（背面）
    function drawBackBody() {
      backCtx.clearRect(0, 0, backCanvas.width, backCanvas.height);

      // 背景
      backCtx.fillStyle = '#f8f9fa';
      backCtx.fillRect(0, 0, backCanvas.width, backCanvas.height);

      // 画像がロードされていれば描画
      if (backBodyImg && backBodyImg.complete) {
        backCtx.drawImage(backBodyImg, 0, 0, backCanvas.width, backCanvas.height);
      }

      // 痛みエリアを描画
      drawPainPoints(backCtx, backPainAreas);
      
      // 現在描画中のパスを描画
      if (currentPath.length > 0 && currentCanvasType === 'back') {
        drawCurrentPath(backCtx);
      }
    }

    // 痛みエリアの描画
    function drawPainPoints(context, areas) {
      areas.forEach(area => {
        if (area.path && area.path.length > 0) {
          context.fillStyle = painColors[area.level];
          context.globalAlpha = 0.6;
          
          context.beginPath();
          context.moveTo(area.path[0].x, area.path[0].y);
          for (let i = 1; i < area.path.length; i++) {
            context.lineTo(area.path[i].x, area.path[i].y);
          }
          context.closePath();
          context.fill();
          
          context.globalAlpha = 1.0;
          context.strokeStyle = '#2c3e50';
          context.lineWidth = 2;
          context.stroke();

          // 痛みレベルを表示（エリアの中央に）
          const centerX = area.path.reduce((sum, p) => sum + p.x, 0) / area.path.length;
          const centerY = area.path.reduce((sum, p) => sum + p.y, 0) / area.path.length;
          
          context.fillStyle = 'white';
          context.strokeStyle = '#2c3e50';
          context.lineWidth = 3;
          context.font = 'bold 14px sans-serif';
          context.textAlign = 'center';
          context.strokeText(area.level, centerX, centerY + 5);
          context.fillText(area.level, centerX, centerY + 5);
        }
      });
    }

    // 描画開始
    function startDrawing(event, type) {
      event.preventDefault();
      let c = (type === 'front') ? canvas : backCanvas;
      const rect = c.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // キャンバス座標に変換
      const canvasX = (x / rect.width) * c.width;
      const canvasY = (y / rect.height) * c.height;

      isDrawing = true;
      currentCanvasType = type;
      currentPath = [{ x: canvasX, y: canvasY }];
    }

    // 描画中
    function draw(event, type) {
      if (!isDrawing || currentCanvasType !== type) return;
      
      event.preventDefault();
      let c = (type === 'front') ? canvas : backCanvas;
      const rect = c.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // キャンバス座標に変換
      const canvasX = (x / rect.width) * c.width;
      const canvasY = (y / rect.height) * c.height;

      currentPath.push({ x: canvasX, y: canvasY });
      
      // リアルタイムで描画
      if (type === 'front') {
        drawBody();
      } else {
        drawBackBody();
      }
    }

    // 描画終了
    function stopDrawing(event, type) {
      if (!isDrawing || currentCanvasType !== type || currentPath.length < 3) {
        isDrawing = false;
        currentPath = [];
        if (type === 'front') {
          drawBody();
        } else {
          drawBackBody();
        }
        return;
      }

      event.preventDefault();
      isDrawing = false;
      
      // 痛みレベル選択モーダルを表示
      modalScreenX = event.clientX;
      modalScreenY = event.clientY;
      modalCanvas = (type === 'front') ? canvas : backCanvas;
      
      showPainModal();
    }

    // 現在描画中のパスを描画
    function drawCurrentPath(context) {
      if (currentPath.length < 2) return;
      
      context.strokeStyle = '#3498db';
      context.lineWidth = 3;
      context.globalAlpha = 0.8;
      
      context.beginPath();
      context.moveTo(currentPath[0].x, currentPath[0].y);
      for (let i = 1; i < currentPath.length; i++) {
        context.lineTo(currentPath[i].x, currentPath[i].y);
      }
      context.stroke();
      
      context.globalAlpha = 1.0;
    }

    // タッチ処理
    function handleTouch(event, type) {
      event.preventDefault();

      if (event.type === 'touchstart') {
        const touch = event.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        startDrawing(mouseEvent, type);
      } else if (event.type === 'touchmove') {
        const touch = event.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        draw(mouseEvent, type);
      } else if (event.type === 'touchend') {
        const touch = event.changedTouches[0];
        const mouseEvent = new MouseEvent('mouseup', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        stopDrawing(mouseEvent, type);
      }
    }

    // 痛みレベル選択モーダル表示
    function showPainModal() {
      const modal = document.getElementById('painModal');
      const modalContent = modal.querySelector('.modal-content');

      // まず一旦非表示にしてから
      modal.style.display = 'none';
      modal.classList.remove('popup');
      modalContent.style.left = '';
      modalContent.style.top = '';
      modalContent.style.position = '';
      modalContent.style.transform = '';

      // 画面上の座標が取得できていればポップアップ表示
      if (modalScreenX !== null && modalScreenY !== null && modalCanvas) {
        // ポップアップ用クラス
        modal.classList.add('popup');
        modal.style.display = 'block';

        // キャンバスの親要素の位置を基準にする
        const canvasRect = modalCanvas.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;

        // モーダルの左上座標（ページ座標）
        let left = modalScreenX + scrollX;
        let top = modalScreenY + scrollY;

        // モーダルサイズを一時的に表示して取得
        modalContent.style.visibility = 'hidden';
        modalContent.style.display = 'block';
        modalContent.style.position = 'absolute';
        modalContent.style.left = '0px';
        modalContent.style.top = '0px';

        // 取得
        const modalW = modalContent.offsetWidth;
        const modalH = modalContent.offsetHeight;

        // 画面端で見切れないように調整
        const margin = 10;
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        if (left + modalW + margin > winW) {
          left = winW - modalW - margin;
        }
        if (left < margin) left = margin;
        if (top + modalH + margin > winH + scrollY) {
          top = winH + scrollY - modalH - margin;
        }
        if (top < margin + scrollY) top = margin + scrollY;

        // 位置セット
        modalContent.style.left = left + 'px';
        modalContent.style.top = top + 'px';
        modalContent.style.visibility = 'visible';
        modalContent.style.display = 'block';
        modalContent.style.position = 'absolute';
        modalContent.style.transform = 'none';

        // pointer-events有効化
        modal.style.pointerEvents = 'none';
        modalContent.style.pointerEvents = 'auto';

      } else {
        // 通常の中央表示
        modal.classList.remove('popup');
        modal.style.display = 'none'; // ここをflexからnoneに変更
        modalContent.style.left = '';
        modalContent.style.top = '';
        modalContent.style.position = '';
        modalContent.style.transform = '';
      }
    }

    // 痛みレベル選択
    function selectPainLevel(level) {
      if (currentPath.length > 0 && currentCanvasType) {
        if (currentCanvasType === 'front') {
          painAreas.push({
            path: [...currentPath],
            level: level
          });
          drawBody();
        } else if (currentCanvasType === 'back') {
          backPainAreas.push({
            path: [...currentPath],
            level: level
          });
          drawBackBody();
        }
        currentPath = [];
        closeModal();
      }
    }

    // モーダルを閉じる
    function closeModal() {
      const modal = document.getElementById('painModal');
      modal.style.display = 'none';
      modal.classList.remove('popup');
      modalScreenX = null;
      modalScreenY = null;
      modalCanvas = null;
      currentPath = [];
      currentCanvasType = null;
      isDrawing = false;
    }

    // キャンバスリセット
    function resetCanvas() {
      if (confirm('全ての痛み記録を削除しますか？')) {
        painAreas = [];
        backPainAreas = [];
        currentPath = [];
        isDrawing = false;
        drawBody();
        drawBackBody();
      }
    }

    // データ保存
    function saveData() {
      const data = {
        painAreas: painAreas,
        backPainAreas: backPainAreas,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem('painData', JSON.stringify(data));
      alert('データを保存しました。');
    }

    // データ読み込み
    function loadData() {
      const saved = localStorage.getItem('painData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          // 旧形式のデータとの互換性を保つ
          if (data.painPoints) {
            // 旧形式のポイントデータをエリアデータに変換
            painAreas = data.painPoints.map(point => ({
              path: [{ x: point.x, y: point.y }],
              level: point.level
            }));
          } else {
            painAreas = data.painAreas || [];
          }
          
          if (data.backPainPoints) {
            // 旧形式のポイントデータをエリアデータに変換
            backPainAreas = data.backPainPoints.map(point => ({
              path: [{ x: point.x, y: point.y }],
              level: point.level
            }));
          } else {
            backPainAreas = data.backPainAreas || [];
          }
        } catch (e) {
          console.error('データの読み込みに失敗しました:', e);
        }
      }
    }

    // モーダル外クリックで閉じる
    window.onclick = function(event) {
      const modal = document.getElementById('painModal');
      if (modal.style.display !== 'none') {
        // ポップアップ表示中はmodal自体が画面全体を覆わないので、modal-content外クリックで閉じる
        if (modal.classList.contains('popup')) {
          if (!modal.querySelector('.modal-content').contains(event.target)) {
            closeModal();
          }
        } else {
          if (event.target === modal) {
            closeModal();
          }
        }
      }
    }

    // ページ読み込み時に初期化
    document.addEventListener('DOMContentLoaded', function() {
      init();
      // 初回描画
      setTimeout(function() {
        drawBody();
        drawBackBody();
      }, 100);
    });
  </script>
</body>
</html>