
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>APOS-HC 調査票 - フォーム3</title>
  <link rel="stylesheet" href="main.css">
  <style>
    /* セクション表示の修正 */
    .section { 
      display: block !important; 
    }
    
    /* iPad用の追加スタイル */
    @media screen and (min-width: 768px) {
      body {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-size: 16px;
        line-height: 1.5;
      }
      
      .container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        padding: 25px;
        margin: 15px 0;
      }
      
      h1 {
        font-size: 1.8em;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 25px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 15px;
      }
      
      h2 {
        font-size: 1.4em;
        color: #34495e;
        margin: 25px 0 15px 0;
        padding: 10px 0;
        border-left: 4px solid #3498db;
        padding-left: 15px;
        background: linear-gradient(90deg, #f8f9fa 0%, transparent 100%);
      }
      
      fieldset {
        border: 2px solid #e0e6ed;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #fafbfc;
        transition: all 0.3s ease;
      }
      
      fieldset:hover {
        border-color: #3498db;
        box-shadow: 0 2px 10px rgba(52, 152, 219, 0.1);
      }
      
      legend {
        font-size: 1.1em;
        font-weight: bold;
        color: #2c3e50;
        padding: 0 10px;
        background: #fff;
        border-radius: 6px;
        border: 2px solid #3498db;
      }
      
      label {
        display: block;
        margin: 10px 0 5px 0;
        font-weight: 600;
        color: #34495e;
        font-size: 1em;
      }
      
      input[type="text"], input[type="tel"], input[type="email"], 
      input[type="number"], select, textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 1em;
        border: 2px solid #e0e6ed;
        border-radius: 6px;
        background: #fff;
        transition: all 0.3s ease;
        box-sizing: border-box;
        margin-top: 5px;
      }
      
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        transform: translateY(-2px);
      }
      
      textarea {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
      }
      
      .daily-rhythm-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      }
      
      .daily-rhythm-table th {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        padding: 12px 10px;
        font-size: 1em;
        font-weight: bold;
        text-align: center;
      }
      
      .daily-rhythm-table td {
        padding: 10px;
        border-bottom: 1px solid #e8f4f8;
        text-align: center;
        vertical-align: middle;
      }
      
      .daily-rhythm-table td:first-child {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9em;
        width: 150px;
      }
      
      .daily-rhythm-table input {
        width: 100%;
        padding: 8px 10px;
        font-size: 0.9em;
        border: 2px solid #e0e6ed;
        border-radius: 6px;
        background: #fff;
        transition: all 0.3s ease;
        margin: 0;
      }
      
      .daily-rhythm-table input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }
      
      .daily-rhythm-table tr:hover {
        background: #f8f9fa;
      }
      
      .note {
        font-size: 0.9em;
        color: #7f8c8d;
        margin-top: 10px;
        padding: 10px;
        background: #ecf0f1;
        border-radius: 6px;
        border-left: 3px solid #95a5a6;
      }
      
      .nav-buttons {
        margin-top: 25px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      
      .nav-buttons button {
        padding: 12px 25px;
        font-size: 1em;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
      }
      
      .nav-buttons button:first-child {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
      }
      
      .nav-buttons button:last-child {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }
      
      .nav-buttons button:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      }
      
      .nav-buttons button:active {
        transform: translateY(-1px);
      }
      
      /* プログレスバーのスタイル */
      .progress-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #e0e0e0;
        padding: 20px;
        z-index: 1000;
      }
      
      .progress-wrapper {
        max-width: 800px;
        margin: 0 auto;
      }
      
      .progress-bar {
        width: 100%;
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 15px;
      }
      
      .progress-fill {
        height: 100%;
        background: #003366;
        border-radius: 3px;
        transition: width 0.5s ease;
        width: 45%;
      }
      
      .progress-info {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.1em;
        color: #333;
        font-weight: 500;
      }
      
      .progress-page {
        color: #003366;
        font-weight: 600;
      }
      
      .progress-total {
        color: #999;
      }
      
      /* フォームの下部に余白を追加（プログレスバーの分） */
      body {
        padding-bottom: 100px;
      }
    }
    
    /* タブレット用の追加調整 */
    @media screen and (max-width: 1024px) and (min-width: 768px) {
      .daily-rhythm-table td:first-child {
        width: 140px;
      }
      
      .daily-rhythm-table input {
        font-size: 0.85em;
        padding: 6px 8px;
      }
    }
  </style>
  <script src="survey-common.js"></script>
</head>
<body>

<div class="container">
<h1>APOS-HC 調査票</h1>
<form id="surveyForm">
<div class="section" id="section-lifestyle-habits">
  <h2>Ⅰ　生活習慣・健康状態</h2>
  <fieldset>
    <legend>日々の健康づくりについてご回答ください</legend>
    <table class="family-table" style="width:100%; font-size:1em;">
      <tr>
        <th style="width:30%;">項目</th>
        <th style="width:70%;">入力内容</th>
      </tr>
      <tr>
        <td>BMI（身長と体重から自動計算されます。下記を参考に該当する範囲を選択）</td>
        <td>
          <select name="bmi_category" id="bmi_category" required onchange="toggleWeightChangeSelect()">
            <option value="">選択してください</option>
            <option value="0">0. 18.5～24.99以下：標準体重</option>
            <option value="1">1. 25.0～29.99：前肥満　</option>
            <option value="2">2. 30.0～34.99：肥満1度</option>
            <option value="3">3. 35.0～39.99：肥満2度</option>
            <option value="4">4. 40.0以上：肥満3度</option>
            <option value="5">5. 17.0～18.49：痩せぎみ</option>
            <option value="6">6. 16.0～16.99：痩せ</option>
            <option value="7">7. 16.0未満：痩せすぎ</option>
            <option value="8">8. BMIで判断できない</option>
          </select>
          <div style="margin-top:0.5em;">
            <label>身長（cm）：<input type="number" name="height" id="height" min="100" max="250" style="width:6em;" placeholder="例: 160"></label>
            <label style="margin-left:1em;">体重（kg）：<input type="number" name="weight" id="weight" min="20" max="200" style="width:6em;" placeholder="例: 60"></label>
            <button type="button" onclick="calcBMI()" style="margin-left:1em;">BMI自動計算</button>
            <span id="bmi_result" style="margin-left:1em; font-weight:bold;"></span>
          </div>
          <div id="bmi-judgment-note" style="margin-top:0.5em; color:#734f04; font-size:0.98em;">
           
          </div>
        </td>
      </tr>
        <td>ここ1ヶ月（30日）の体重変動</td>
        <td>
          <select name="weight_change" id="weight_change_select">
            <option value="">選択してください</option>
            <option value="0">0. 変化なし、3％未満</option>
            <option value="1">1. 体重の3～5％の減（中リスク）</option>
            <option value="2">2. 体重の5％以上の減（高リスク）</option>
            <option value="3">3. 測定不能</option>
          </select>
        <div style="margin-top:0.5em; color:#b85c00; font-size:0.97em;">
          ※ＢＭＩで判断できない人はこの質問に回答する
        </div>
        </td>
      </tr>
      <script>
        function toggleWeightChangeSelect() {
          var bmiCategory = document.getElementById('bmi_category').value;
          var weightChangeRow = document.getElementById('weight_change_row');
          var weightChangeSelect = document.getElementById('weight_change_select');
          if (bmiCategory === '8') {
            weightChangeRow.style.display = '';
            weightChangeSelect.setAttribute('required', 'required');
          } else {
            weightChangeRow.style.display = 'none';
            weightChangeSelect.removeAttribute('required');
            weightChangeSelect.value = "";
          }
        }
      </script>
      <script>
        function calcBMI() {
          const height = parseFloat(document.getElementById('height').value);
          const weight = parseFloat(document.getElementById('weight').value);
          let bmi = '';
          if (height && weight) {
            bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            document.getElementById('bmi_result').textContent = 'BMI: ' + bmi;
            // BMI区分自動選択
            const bmiCategory = document.getElementById('bmi_category');
            if (bmi < 18.5) bmiCategory.value = "1";
            else if (bmi < 25) bmiCategory.value = "2";
            else if (bmi < 30) bmiCategory.value = "3";
            else if (bmi < 35) bmiCategory.value = "4";
            else if (bmi < 40) bmiCategory.value = "5";
            else bmiCategory.value = "6";
          } else {
            document.getElementById('bmi_result').textContent = '';
          }
        }
      </script>
        <td>栄養／食事の自己管理</td>
        <td>
          <select name="nutrition_self_management" id="nutrition_self_management" required style="width:98%;">
            <option value="">選択してください</option>
            <option value="0">0．常に健康が保てるよう、食べやすいバランスの取れた⾷⽇記・⾷材・栄養剤での⾷事をしている</option>
            <option value="1">1．ある程度⾷べやすく、バランスのとれた⾷⽇記・⾷材・栄養剤での⾷事をしている</option>
            <option value="2">2．誰かが準備した物のみ、⾷べやすくバランスの取れた⾷⽇記・⾷材での⾷事を⾷べている</option>
            <option value="3">3．全て出前やお店⾷で済ませ、⾷材のバランスや⾷べやすさは考えていない。量が多い又は少ない</option>
            <option value="4">4．栄養は考えず好きなものを⾷べる、⾃⾝た⾷⾷パターンを変えることはしたくない</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>
          <span style="font-size:1.1em;vertical-align:middle;">
            食事療法
          </span>
        </td>
        <td>
          <select name="dietary_therapy" id="dietary_therapy" required style="font-size:1em;">
            <option value="">選択してください</option>
            <option value="0">0. なし</option>
            <option value="1">1. 食事療法あり</option>
          </select>
        </td>
      </tr>
        </td>
        <td>食べられる形（咀嚼・嚥下・摂食の様式）</td>
        <td>
          <select name="nutrition_self_management" id="nutrition_self_management" required style="width:98%;">
            <option value="">選択してください</option>
            <option value="0">0．固形食（噛む・飲み込むといった動作に問題なく食べられている）</option>
            <option value="1">1．きざみ食（固形だが細かく切って、飲み込みにくさを感じる時）</option>
            <option value="2">2．ソフト食（噛み砕かなくても飲み込めるが、普通のご飯やおかずもついており混ぜての食事）</option>
            <option value="3">3．ムース食（歯ぐきで潰せるか飲み込めるかの食事。ミキサー・ゼリー等つぶつぶしない混じりのない食事）</option>
            <option value="4">4．流動食や飲み物で摂取している状態で、家庭など以外ではミキサーやレベルスードにして提供可</option>
            <option value="5">5．完全流動食（噛める歯は、使わずに、調理済みではなく、飲料を選択した場合やスープのみの食事）</option>
            <option value="6">6．とろみ水または水分のみ</option>
          </select>
        </td>
 
      </tr>
      <tr>
        <td>4. 食べられる形（咀嚼/嚥下調節食の検討）</td>
        <td>
          <select name="sleep_quality" id="sleep_quality" required>
            <option value="">選択してください</option>
            <option value="0">0. 夜間に日中/夜間の睡眠をとっており休息感がある</option>
            <option value="1">1. 日中/夜間の睡眠をとっているが休息感がない</option>
            <option value="2">2. 日中/夜間の睡眠をとれず中休息感がない</option>
            <option value="3">3. 睡眠のパターンがない、日中眠すぎて夜眠れない、夜間眠れず休息感がない</option>
          </select>
        </td>
      </tr>
      <tr>
        <tr>
            <td>5. 食事回数</td>
            <td>
              <select name="meal_frequency" id="meal_frequency" required>
                <option value="">選択してください</option>
                <option value="0">0．朝・昼・夕食3回食</option>
                <option value="1">1．日2回食（朝・昼・夕）</option>
                <option value="2">2．日1回食（朝・昼・夕）</option>
                <option value="3">3．3回以上</option>
                <option value="4">人工的な栄養補給（経管栄養：胃ろう・腸ろう・経静脈栄養点滴・中心静脈栄養）毎回以上入れる</option>
              </select>
            </td>
          </tr>
          <tr>
        <td>5. 他者と一緒の食事（過去７日）</td>
        <td>
          <select name="fatigue" id="fatigue" required onchange="document.getElementById('fatigue_detail').style.display = this.value === '1' ? 'inline-block' : 'none';">
            <option value="">選択してください</option>
            <option value="0">0. なし</option>
            <option value="1">1. あり（強い疲労感・慢性的な疲れなど）</option>
          </select>
          <input type="text" name="fatigue_detail" id="fatigue_detail" style="display:none; margin-left:8px;" placeholder="内容を記入してください">
        </td>
      </tr>
      <tr>
    </tr>
    <tr>
      <td>6. １日の水分量<br><span style="font-size:0.95em;">（飲水・食事・点滴を含む）</span></td>
      <td>
        <select name="water_intake" id="water_intake" required>
          <option value="">選択してください</option>
          <option value="0">0．1000ml～2500ml</option>
          <option value="1">1．少ない（1000ml未満）</option>
          <option value="2">2．大変少ない（500ml未満）</option>
          <option value="3">3．非常に多い（3000ml以上）</option>
        </select>
      </td>
    </tr>
        <td>7. 身体活動・運動</td>
        <td>
          <select name="swallowing" id="swallowing" required>
            <option value="">選択してください</option>
            <option value="0">0. 固形物・水を問題なく飲み込める</option>
            <option value="1">1. お茶や汁物を含ませてしまいむせ込みにくい</option>
            <option value="2">2. 口腔移動がうまく、呑み込むにくい</option>
            <option value="3">3. おかゆ・ゼリー・とろみ食でも含ませてしまい呑み込みにくい</option>
            <option value="4">4. 嚥下できない</option>
          </select>
        </td>
      </tr>

            <th style="width:30%;">8. 口腔内評価</th>
            <th style="width:70%;">評価</th>
          </tr>
          <tr>
            <tbody>
              <tr>
                <td>歯・歯肉の状態</td>
                <td>
                  <select name="oral_teeth_gum" required>
                    <option value="">選択してください</option>
                    <option value="0">0：現状のケア方法を継続（問題なし）</option>
                    <option value="1">1：改善がなければ専門職へのアセスメントの依頼を検討（要注意）</option>
                    <option value="2">2：治療、積極的な専門的介入が必要（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>ケア時容易に歯に関する</td>
                <td>
                  <select name="oral_care_easy" required>
                    <option value="">選択してください</option>
                    <option value="0">0：ケア時容易に歯に関する（問題なし）</option>
                    <option value="1">1：口腔に近づくと口臭を感じる（要注意）</option>
                    <option value="2">2：治療、積極的な専門的介入が必要（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>口臭</td>
                <td>
                  <select name="oral_breath" required>
                    <option value="">選択してください</option>
                    <option value="0">0：なし（問題なし）</option>
                    <option value="1">1：軽度の口臭あり（要注意）</option>
                    <option value="2">2：強い口臭あり（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>よだれ</td>
                <td>
                  <select name="oral_saliva_flow" required>
                    <option value="">選択してください</option>
                    <option value="0">0：なし（問題なし）</option>
                    <option value="1">1：嚥下反射の低下で軽度に流涎あり（要注意）</option>
                    <option value="2">2：頻繁な流涎あり、衣服や枕を汚す（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>口腔乾燥度</td>
                <td>
                  <select name="oral_dryness" required>
                    <option value="">選択してください</option>
                    <option value="0">0：唾液量正常（問題なし）</option>
                    <option value="1">1：唾液が少なめ、ネバネバ（要注意）</option>
                    <option value="2">2：著しい乾燥、カラカラ（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>唾液</td>
                <td>
                  <select name="oral_saliva" required>
                    <option value="">選択してください</option>
                    <option value="0">0：正常（問題なし）</option>
                    <option value="1">1：やや少ない／粘りあり（要注意）</option>
                    <option value="2">2：明らかに少ない、粘稠で糸を引く（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>義歯の状態</td>
                <td>
                  <select name="oral_denture_condition" required>
                    <option value="">選択してください</option>
                    <option value="0">0：良好（歯肉に適合している）（問題なし）</option>
                    <option value="1">1：部分的に不適合／食事時違和感あり（要注意）</option>
                    <option value="2">2：合わない、装着困難、外れやすい（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>舌</td>
                <td>
                  <select name="oral_tongue" required>
                    <option value="">選択してください</option>
                    <option value="0">0：正常（ピンク）（問題なし）</option>
                    <option value="1">1：浮腫、ブラッシングで出血、赤赤（要注意）</option>
                    <option value="2">2：黒毛舌、強い乾燥、出血（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>口腔粘膜</td>
                <td>
                  <select name="oral_mucosa" required>
                    <option value="">選択してください</option>
                    <option value="0">0：潤沢し正常（問題なし）</option>
                    <option value="1">1：赤み・糜爛など自覚の変化（要注意）</option>
                    <option value="2">2：潰瘍、白板症、強い発赤（問題あり）</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>歯肉</td>
                <td>
                  <select name="oral_gum" required>
                    <option value="">選択してください</option>
                    <option value="0">0：引きしまっている、ピンク色（問題なし）</option>
                    <option value="1">1：浮腫、ブラッシングで出血、赤赤（要注意）</option>
                    <option value="2">2：自然に出血、腫れ、むずむず出血（問題あり）</option>
                  </select>
                </td>
              </tr>

    </table>
  </fieldset>
</div>


    <div class="nav-buttons">
      <button type="button" onclick="location.href='form6.html'">← 戻る</button>
      <button type="button" onclick="location.href='form8.html'">次へ →</button>
    </div>
  </form>
</div>

<script>
  // 高額費用の利用：理由欄表示
  function toggleExpensiveCostDetail() {
    const val = document.getElementById('expensive_cost_usage').value;
    const reasonDiv = document.getElementById('expensive_cost_reason');
    if (val === '2a' || val === '2b') {
      reasonDiv.style.display = 'block';
    } else {
      reasonDiv.style.display = 'none';
    }
  }
  
  // 公費医療の利用：理由欄表示
  function togglePublicMedicalReason() {
    const val = document.getElementById('public_medical_usage').value;
    const reasonDiv = document.getElementById('public_medical_reason');
    if (val === '2') {
      reasonDiv.style.display = 'block';
    } else {
      reasonDiv.style.display = 'none';
    }
  }
  
  // 公費医療の詳細：病名入力欄表示
  function toggleMedicalDiseaseInput() {
    const val = document.getElementById('public_medical_detail').value;
    const inputDiv = document.getElementById('medical_disease_input');
    if (val === '5' || val === '3') {
      inputDiv.style.display = 'block';
    } else {
      inputDiv.style.display = 'none';
    }
  }
  
  // 公費制度の利用：理由欄表示
  function togglePublicSystemReason() {
    const val = document.getElementById('public_system_usage').value;
    const reasonDiv = document.getElementById('public_system_reason');
    if (val === '2') {
      reasonDiv.style.display = 'block';
    } else {
      reasonDiv.style.display = 'none';
    }
  }
  
  // 公費制度の詳細：詳細入力欄表示
  function toggleSystemDetailInput() {
    const val = document.getElementById('public_system_detail').value;
    const inputDiv = document.getElementById('system_detail_input');
    if (val === '1' || val === '2') {
      inputDiv.style.display = 'block';
    } else {
      inputDiv.style.display = 'none';
    }
  }

  // フォームの自動保存機能
  const form = document.getElementById('surveyForm');
  form.addEventListener('input', () => {
    const data = Object.fromEntries(new FormData(form));
    localStorage.setItem('surveyData_form2', JSON.stringify(data));
  });

  // 保存されたデータの復元
  window.addEventListener('load', () => {
    const saved = localStorage.getItem('surveyData_form2');
    if (saved) {
      const data = JSON.parse(saved);
      Object.keys(data).forEach(key => {
        const el = form.elements[key];
        if (el) {
          el.value = data[key];
        }
      });
    }
  });
</script>

  <!-- プログレスバー -->
  <div class="progress-container">
    <div class="progress-wrapper">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-info">
        <span class="progress-page" id="currentPage">9</span>
        <span class="progress-total">/ 20</span>
      </div>
    </div>
  </div>

  <script>
    // プログレスバーの更新
    function updateProgress() {
      const progressPercentage = (9 / 20) * 100;
      const progressFill = document.getElementById('progressFill');
      const currentPageElement = document.getElementById('currentPage');
      
      progressFill.style.width = progressPercentage + '%';
      currentPageElement.textContent = '9';
      progressFill.style.background = '#003366';
    }
    
    // 初期プログレス更新
    document.addEventListener('DOMContentLoaded', function() {
      updateProgress();
      
      // フォームの自動保存機能
      const form = document.getElementById('surveyForm');
      const formNumber = 7;
      
      if (form) {
        function collectFormData() {
          const formData = new FormData(form);
          const data = {};
          for (let [key, value] of formData.entries()) {
            if (data[key]) {
              if (Array.isArray(data[key])) {
                data[key].push(value);
              } else {
                data[key] = [data[key], value];
              }
            } else {
              data[key] = value;
            }
          }
          const canvases = form.querySelectorAll('canvas');
          canvases.forEach((canvas, index) => {
            try {
              const canvasId = canvas.id || `canvas_${index}`;
              data[canvasId + '_image'] = canvas.toDataURL('image/png');
            } catch (e) {
              console.error('Canvas保存エラー:', e);
            }
          });
          const allInputs = form.querySelectorAll('input, select, textarea');
          allInputs.forEach(input => {
            if (!input.name) return;
            const isProcessed = data.hasOwnProperty(input.name);
            if (input.type === 'checkbox') {
              if (input.checked) {
                if (!data[input.name]) data[input.name] = [];
                if (Array.isArray(data[input.name])) {
                  if (!data[input.name].includes(input.value)) data[input.name].push(input.value);
                } else {
                  data[input.name] = [data[input.name], input.value];
                }
              }
            } else if (input.type === 'radio') {
              if (input.checked && !isProcessed) data[input.name] = input.value;
            } else {
              if (!isProcessed && input.value) data[input.name] = input.value;
            }
          });
          return data;
        }
        
        form.addEventListener('input', function() {
          const data = collectFormData();
          localStorage.setItem(getFormStorageKey(formNumber), JSON.stringify(data));
          console.log(`Form ${formNumber} データを自動保存しました`);
        });
        
        form.addEventListener('change', function() {
          const data = collectFormData();
          localStorage.setItem(getFormStorageKey(formNumber), JSON.stringify(data));
          console.log(`Form ${formNumber} データを自動保存しました`);
        });
        
        const savedData = localStorage.getItem(getFormStorageKey(formNumber));
        if (savedData) {
          const data = JSON.parse(savedData);
          Object.keys(data).forEach(key => {
            const elements = form.elements[key];
            if (elements) {
              if (elements.length > 1) {
                Array.from(elements).forEach(el => {
                  if (el.type === 'checkbox' || el.type === 'radio') {
                    if (Array.isArray(data[key])) {
                      el.checked = data[key].includes(el.value);
                    } else {
                      el.checked = el.value === data[key];
                    }
                  }
                });
              } else if (elements.length === 1) {
                const el = elements[0];
                if (el.type === 'checkbox' || el.type === 'radio') {
                  if (Array.isArray(data[key])) {
                    el.checked = data[key].includes(el.value);
                  } else {
                    el.checked = el.value === data[key];
                  }
                } else {
                  el.value = data[key] || '';
                }
              } else {
                if (elements.type === 'checkbox' || elements.type === 'radio') {
                  if (Array.isArray(data[key])) {
                    elements.checked = data[key].includes(elements.value);
                  } else {
                    elements.checked = elements.value === data[key];
                  }
                } else {
                  elements.value = data[key] || '';
                }
              }
            }
          });
          console.log(`Form ${formNumber} の保存データを復元しました`);
        }
      }
    });
  </script>

</body>
</html>



