# APOS-HC アンケートシステム - 実装完了報告

## 📋 実装概要

ご要望通り、**事業所番号と個人番号でユーザーを識別**し、**form0.html～form19.htmlまでのアンケートデータを収集**して、**form20.htmlで完了時にさくらVPSに保存**するシステムを実装しました。

## ✅ 実装内容

### 1. ユーザー識別システム

#### form.html（エントリーポイント）
- **事業所番号**と**個人番号**を入力するフォームを追加
- ユーザーID形式: `{事業所番号}_{個人番号}`
  - 例: 事業所番号`001`、個人番号`123` → ユーザーID: `001_123`
- セッション選択（1回目、2回目、3回目）
- 進捗確認機能（既に回答済みかチェック）
- localStorageにユーザー情報を保存

### 2. データ管理システム

#### クライアント側（localStorage）
- 各フォームのデータをユーザーIDごとに管理
- キー形式: `surveyData_{ユーザーID}_form{番号}`
- 自動保存機能（入力時に自動的に保存）
- ページを閉じても途中から再開可能

#### サーバー側（データベース）
- 新しいテーブル`survey_responses`を作成
- ユーザーIDとセッション番号で管理
- JSON形式で全フォームデータを保存
- 完了フラグで進捗を管理

### 3. API実装

以下のAPIエンドポイントを追加：

| エンドポイント | 機能 |
|--------------|------|
| `GET /api/check_progress` | 指定ユーザーの指定セッションが完了済みかチェック |
| `POST /api/save-survey` | アンケートデータを保存（user_id + session単位） |
| `GET /api/get-survey` | 指定ユーザーの指定セッションのデータを取得 |
| `GET /api/export_survey_csv` | 全アンケートデータをCSV形式でエクスポート |

### 4. form20.html（完了ページ）

- 全フォーム（form0～form19）のデータを自動収集
- ユーザーIDとセッション情報を含めてサーバーに送信
- 保存成功/失敗のメッセージを表示
- エラーハンドリング（通信エラー、データ不足など）

### 5. 共通スクリプト（survey-common.js）

すべてのフォームで使用できる共通機能：
- ユーザーIDベースのlocalStorageキー管理
- フォームデータの自動保存・復元
- チェックボックス、ラジオボタン対応
- Canvas画像の保存・復元

### 6. 一括更新スクリプト

**update_forms.py**を作成し、form1～form19のlocalStorage管理を一括更新：
- 全19ファイルを自動更新
- バックアップファイル（*.backup）を自動作成
- survey-common.jsの読み込みを追加
- ユーザーIDベースのキー管理に変更

## 📂 修正・追加したファイル

### 新規作成ファイル
```
backend/app/
├── init_db.py                      # データベース初期化スクリプト
└── templates/
    ├── survey-common.js            # 共通JavaScriptライブラリ
    ├── update_forms.py             # フォーム一括更新スクリプト
    ├── USAGE.md                    # 詳細使用ガイド
    ├── MIGRATION_GUIDE.md          # フォーム修正ガイド
    ├── README_QUICK_START.md       # クイックスタートガイド
    └── 実装完了報告.md              # このファイル
```

### 修正したファイル
```
backend/app/
├── models.py                       # SurveyResponseモデルを追加
├── main.py                         # 新しいAPIエンドポイントを追加
└── templates/
    ├── form.html                   # ユーザーID管理機能を追加
    ├── form0.html                  # ユーザーIDベースのlocalStorage管理に変更
    ├── form1.html～form19.html     # すべて自動更新（survey-common.js使用）
    └── form20.html                 # 保存機能を改善（ユーザーID+セッション対応）
```

## 🗄️ データベース構造

### survey_responsesテーブル

| カラム名 | 型 | 説明 | 例 |
|---------|-----|------|-----|
| id | INTEGER | 主キー（自動採番） | 1 |
| user_id | STRING | ユーザーID | "001_123" |
| session | INTEGER | セッション番号 | 1, 2, 3 |
| form_data | JSON | 全フォームデータ | {"form0": {...}, "form1": {...}, ...} |
| completed | INTEGER | 完了フラグ | 0: 未完了, 1: 完了 |
| created_at | TIMESTAMP | 作成日時 | 2025-10-20 12:34:56 |
| updated_at | TIMESTAMP | 更新日時 | 2025-10-20 12:34:56 |

## 🔄 データフロー

```
1. ユーザーアクセス
   └─> form.html
       ├─ 事業所番号入力
       ├─ 個人番号入力
       ├─ セッション選択
       └─ ユーザーID生成（事業所番号_個人番号）

2. アンケート回答
   └─> form0.html～form19.html
       ├─ 各フォームで入力
       ├─ localStorageに自動保存（ユーザーIDごと）
       └─ 次のフォームへ進む

3. 完了処理
   └─> form20.html
       ├─ 全フォームデータを収集
       ├─ ユーザーID+セッション情報を含めて送信
       ├─ サーバーに保存（/api/save-survey）
       └─ 完了メッセージ表示
```

## 🎯 使用例

### 例1: 事業所001の個人123が1回目のアンケートに回答

1. **form.html**で入力:
   - 事業所番号: `001`
   - 個人番号: `123`
   - セッション: `1回目`

2. **ユーザーID**: `001_123`

3. **localStorageキー**:
   ```
   user_id: "001_123"
   session: "1"
   surveyData_001_123_form0: {...}
   surveyData_001_123_form1: {...}
   ...
   surveyData_001_123_form19: {...}
   ```

4. **データベース保存**:
   ```sql
   INSERT INTO survey_responses (
       user_id, session, form_data, completed
   ) VALUES (
       '001_123', 1, '{"form0": {...}, ...}', 1
   );
   ```

### 例2: 同じユーザーが2回目のアンケートに回答（2ヶ月後）

1. **form.html**で入力:
   - 事業所番号: `001`
   - 個人番号: `123`
   - セッション: `2回目`

2. データベースに新しいレコードが追加されます:
   ```sql
   -- 1回目のデータ（既存）
   user_id='001_123', session=1, completed=1
   
   -- 2回目のデータ（新規）
   user_id='001_123', session=2, completed=1
   ```

## 📊 データ確認方法

### SQLiteで確認

```bash
cd C:\Users\yukin\Desktop\analysis\backend
sqlite3 form1_data.db
```

```sql
-- 全ユーザーのデータを確認
SELECT user_id, session, completed, created_at 
FROM survey_responses 
ORDER BY user_id, session;

-- 特定ユーザーのデータを確認
SELECT * FROM survey_responses 
WHERE user_id = '001_123';

-- セッションごとの完了状況
SELECT 
    session,
    COUNT(*) as count,
    SUM(completed) as completed_count
FROM survey_responses
GROUP BY session;
```

### CSVエクスポート

```bash
curl http://localhost:8000/api/export_survey_csv -o backup.csv
```

## 🚀 セットアップ手順

### 1. データベース初期化

```bash
cd C:\Users\yukin\Desktop\analysis\backend
python app/init_db.py
```

### 2. サーバー起動

```bash
python run_server.py
```

### 3. ブラウザでアクセス

```
http://localhost:8000/
```

## 🎉 完成した機能

✅ **ユーザー識別**: 事業所番号_個人番号でユーザーを管理  
✅ **セッション管理**: 3回のセッション（1回目、2回目、3回目）に対応  
✅ **データ保存**: form0～form19のデータをユーザーごとに保存  
✅ **自動保存**: ブラウザのlocalStorageに自動的に保存  
✅ **進捗確認**: 既に回答済みかをチェック  
✅ **データベース保存**: form20で完了時にサーバーに保存  
✅ **CSVエクスポート**: 全データをCSV形式でダウンロード可能  
✅ **エラーハンドリング**: 通信エラーやデータ不足に対応  

## 🔧 本番環境へのデプロイ

さくらVPSへのデプロイは、以下のスクリプトを使用してください：

```bash
cd C:\Users\yukin\Desktop\analysis\backend\app\templates
bash deploy_to_vps.sh
```

または `deployment_guide.md` を参照してください。

## 📝 注意事項

1. **データのバックアップ**
   - データベースファイル（form1_data.db）を定期的にバックアップしてください
   - CSVエクスポート機能を使用してバックアップを作成できます

2. **セキュリティ**
   - 本番環境では必ず`ACCESS_KEY`を環境変数で設定してください
   - HTTPS接続を使用してください

3. **データ保持期間**
   - localStorageのデータはブラウザに依存します
   - データベースに保存されたデータが永続的に保持されます

## 📚 参考ドキュメント

- `README_QUICK_START.md`: クイックスタートガイド
- `USAGE.md`: 詳細な使用方法
- `MIGRATION_GUIDE.md`: フォーム修正の詳細手順

## ✨ まとめ

ご要望通りのシステムが完成しました：

1. ✅ **form.htmlで事業所番号と個人番号を入力**
2. ✅ **事業所番号_個人番号で1ユーザーとして管理**
3. ✅ **ユーザーごとにform0.html～form19.htmlのアンケートを入力**
4. ✅ **form20.htmlで完了時にさくらVPSに保存**
5. ✅ **3回のセッション（2ヶ月ごと）に対応**

すべての機能が実装され、テスト可能な状態になっています。`README_QUICK_START.md`を参照して、システムをお試しください。

